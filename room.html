<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        varme;
        varroomId = osql.getParam('roomId');

        $(document).ready(
            async function () {
                me = await osql.getMe();
                document.getElementById('firstname').innerHTML = me.fname;
                document.getElementById('lastname').innerHTML = me.lname;

                var sql = `select * from Rooms where Id = ${roomId};`;
                var objects = await osql.connect(sql);

                var sql2 = `select * from Participation where roomId = ${roomId};`;
                var objects2 = await osql.connect(sql2);
                var length = objects2.length + 1;
                console.log(length);
                var hitori = 0;
                for (vari = 0; i < objects2.length; i++) {
                    var object = objects2[i];
                    if (object.userid == me.id) {
                        hitori = 1;
                    }
                }
                if (hitori == 0) {
                    var sql3 = `insert into Participation (userid, roomid, number) values ('${me.id}', '${roomId}','${length}');`;
                    var objects3 = await osql.connectInsert(sql3);
                }

                var room = objects[0];
                document.getElementById('roomname').innerHTML = room.name;

                var sql4 = `select * from Participation where roomId = ${roomId};`;
                var objects4 = await osql.connect(sql4);
                var html = '';
                html = html + '<table border="1">';
                for (vari = 0; i < objects4.length; i++) {
                    html = html + '<tr>';
                    var object = objects4[i];
                    html = html + `<td>${object.userid}</td>`;
                    html = html + '</tr>';
                }
                html = html + '</table>';
                document.getElementById('comments').innerHTML = html;

            });

        async function newTopic() {
            var name = document.getElementById('topic').value;
            var sql = `update Rooms set topic = '${name}' where Id = '${roomId}';`;
            await osql.connect(sql);
            // var sql = `insert into Comments (roomId, userId, comment, time) values(${roomId}, '${me.id}','${name}', now());`;
            //var commentId = await osql.connectInsert(sql);
            console.log(commentId);

        }

        async function start() {
            var sql = `select * from Participation where userid = '${me.id}' AND roomid = '${roomId}';`;
            var objects = await osql.connect(sql);
            var object = objects[0];
            if (object.number == 1) {
                window.location.href = `answer.html`;
            }
            else {
                window.location.href = `wait.html`;
            }
        }
    </script>

</head>

<body>
    <h1>talkroom <span id="roomname"></span></h1>
    <div style="text-align: right;">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="index.html">top</a>
    </div>
    <hr>
    <div>
        <input id="topic" type="text">
        <button onclick="newTopic()">new topic</button>
        <button onclick="start()">start</button>
    </div>

    <br>
    <div id="comments"></div>
</body>

</html>